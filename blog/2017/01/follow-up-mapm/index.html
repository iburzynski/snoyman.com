
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Follow up on mapM_</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Follow up on mapM_">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Follow up on mapM_</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published January 19, 2017</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Follow%20up%20on%20mapM_ https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;follow-up-mapm&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;follow-up-mapm&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;follow-up-mapm&#x2F;&amp;title=Follow%20up%20on%20mapM_" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;follow-up-mapm&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;follow-up-mapm.md">Edit this page on Github</a>
        </i>
      </p>

      <p>This is a short follow-up to my
<a href="/blog/2017/01/foldable-mapm-maybe-and-recursive-functions">blog post about mapM_ and Maybe</a>. Roman
Cheplyaka <a href="http://disq.us/p/1f5uz82">started a discussion</a> on that
post, and ultimately we came up with the following implementation of
<code>mapM_</code> which works for all <code>Foldable</code>s and avoids the
non-tail-recursive case for <code>Maybe</code> as desired:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#b58900;">mapM_ </span><span style="color:#859900;">::</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">Applicative m</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">Foldable f</span><span style="color:#657b83;">) </span><span style="color:#859900;">=&gt;</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m </span><span style="color:#859900;">()</span><span style="color:#657b83;">) </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">f a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m </span><span style="color:#859900;">()
</span><span style="color:#657b83;">mapM_ f a </span><span style="color:#859900;">=</span><span style="color:#657b83;">
    go (toList a)
  </span><span style="color:#859900;">where</span><span style="color:#657b83;">
    go </span><span style="color:#b58900;">[] </span><span style="color:#859900;">=</span><span style="color:#657b83;"> pure </span><span style="color:#b58900;">()</span><span style="color:#657b83;">
    go [x] </span><span style="color:#859900;">=</span><span style="color:#657b83;"> f x </span><span style="color:#93a1a1;">-- here&#39;s the magic
</span><span style="color:#657b83;">    go (x</span><span style="color:#859900;">:</span><span style="color:#657b83;">xs) </span><span style="color:#859900;">=</span><span style="color:#657b83;"> f x *</span><span style="color:#859900;">&gt;</span><span style="color:#657b83;"> go xs
</span></code></pre>
<p>Why is this useful? If you implement <code>mapM_</code> directly in terms of
<code>foldr</code> or <code>foldMap</code>, there is no way to tell that you are currently
looking at the last element in the structure, and therefore will
always end up with the equivalent of <code>f x *&gt; pure ()</code> in your expanded
code. By contrast, with explicit pattern matching on the list-ified
version, we can easily pattern match with <code>go [x]</code> and avoid <code>*&gt; pure ()</code> bit, thereby making tail recursion possible.</p>
<p>Some interesting things to note:</p>
<ul>
<li>Using <code>() &lt;$ f x</code> instead of <code>f x *&gt; pure ()</code> or <code>f x &gt;&gt; return ()</code>
seemed to make no difference for tail recursion purposes.</li>
<li>As a result of that, we still need to have the <code>()</code>-specialized type
signature I describe in the previous blog post, there doesn't seem
to be a way around that.</li>
<li>As you can see from the benchmark which I
<a href="https://gist.github.com/snoyberg/2239e7601306371058ca0e5650dfcd2d">unceremoniously ripped off from Roman</a>,
there do not appear to be cases where this version has more memory
residency than <code>mapM_</code> from <code>base</code>. Roman had raised the concern
that the intermediate list may involve extra allocations, though it
appears that GHC is smart enough to avoid them.</li>
</ul>
<p>Here are the results. Notice the significantly higher residency
numbers for <code>base</code>:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">   5000      roman          36,064 bytes
   5000    michael          36,064 bytes
   5000       base          36,064 bytes
  50000      roman          36,064 bytes
  50000    michael          36,064 bytes
  50000       base         133,200 bytes
 500000      roman          44,384 bytes
 500000    michael          44,384 bytes
 500000       base       2,354,216 bytes
5000000      roman          44,384 bytes
5000000    michael          44,384 bytes
5000000       base      38,235,176 bytes
</span></code></pre>
<p>My takeaway from all of this: it's probably too late to change the
type signature of <code>mapM_</code> and <code>forM_</code> in <code>base</code>, but this alternative
implementation is a
<a href="https://github.com/snoyberg/mono-traversable/pull/121">good fit for mono-traversable</a>. Perhaps
there are some rewrite rules that could be applied in <code>base</code> to get
the benefits of this implementation as well.</p>
<hr />
<p>Completely tangential, but: as long as I'm linking to pull requests
based on blog posts, I've
<a href="https://github.com/snoyberg/mono-traversable/pull/120">put together a PR</a>
for classy-prelude and conduit-combinators that gets rid of
generalized I/O operations, based on my
<a href="http://www.snoyman.com/blog/2016/12/beware-of-readfile">readFile blog post</a>.</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
