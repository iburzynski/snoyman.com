
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Foldable.mapM_, Maybe, and recursive functions</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Foldable.mapM_, Maybe, and recursive functions">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Foldable.mapM_, Maybe, and recursive functions</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published January 10, 2017</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Foldable.mapM_%2C%20Maybe%2C%20and%20recursive%20functions https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;foldable-mapm-maybe-and-recursive-functions&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;foldable-mapm-maybe-and-recursive-functions&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;foldable-mapm-maybe-and-recursive-functions&#x2F;&amp;title=Foldable.mapM_%2C%20Maybe%2C%20and%20recursive%20functions" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;01&#x2F;foldable-mapm-maybe-and-recursive-functions&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;foldable-mapm-maybe-and-recursive-functions.md">Edit this page on Github</a>
        </i>
      </p>

      <p><strong>NOTE</strong> This content originally appeared on <a href="https://www.schoolofhaskell.com/user/snoyberg/general-haskell/basics/foldable-mapm-maybe-and-recursive-functions">School of Haskell</a>.</p>
<p>I've
<a href="https://github.com/snoyberg/conduit/commit/11877684b3adb7ca422ae5000fab1ebeb3fbe142">run into this issue myself</a>,
and seen others hit it too. Let's start off with some very simple
code:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc runghc
</span><span style="color:#b58900;">sayHi </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Maybe String </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">sayHi mname </span><span style="color:#859900;">=
    case</span><span style="color:#657b83;"> mname </span><span style="color:#859900;">of
        </span><span style="color:#cb4b16;">Nothing </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()
        </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> name </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hello, </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> name

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> sayHi </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">Just </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Alice</span><span style="color:#839496;">&quot;
</span></code></pre>
<p>There's nothing amazing about this code, it's pretty straight-forward
pattern matching Haskell. And at some point, many Haskellers end up
deciding that they don't like the explicit pattern matching, and
instead want to use a combinator. So the code above might get turned
into one of the following:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc runghc
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Foldable </span><span style="color:#657b83;">(</span><span style="color:#b58900;">forM_</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">hiHelper </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">String </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">hiHelper name </span><span style="color:#859900;">=</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hello, </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> name

</span><span style="color:#b58900;">sayHi1 </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Maybe String </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">sayHi1 </span><span style="color:#859900;">=</span><span style="color:#657b83;"> maybe (return </span><span style="color:#b58900;">()</span><span style="color:#657b83;">) hiHelper

</span><span style="color:#b58900;">sayHi2 </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Maybe String </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">sayHi2 </span><span style="color:#859900;">=</span><span style="color:#657b83;"> mapM_ hiHelper

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    sayHi1 </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">Just </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Alice</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
    sayHi2 </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">Just </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Bob</span><span style="color:#839496;">&quot;
    </span><span style="color:#93a1a1;">-- or often times this:
</span><span style="color:#657b83;">    forM_ (</span><span style="color:#cb4b16;">Just </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Charlie</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">) hiHelper
</span></code></pre>
<p>The theory is that all three approaches (<code>maybe</code>, <code>mapM_</code>, and
<code>forM_</code>) will end up being identical. We can fairly conclusively state
that <code>forM_</code> will be the exact same thing as <code>mapM_</code>, since
<a href="https://www.stackage.org/haddock/lts-7.14/base-4.9.0.0/src/Data-Foldable.html#forM_">it's just <code>mapM_</code> flipped</a>. So
the question is: will the <code>maybe</code> and <code>mapM_</code> approaches do the same
thing? In this case, the answer is yes, but let's spice it up a bit
more. First, the <code>maybe</code> version:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc exec -- ghc -with-rtsopts -s
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">when</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">uncons </span><span style="color:#859900;">::</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Maybe</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">, [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">])
uncons </span><span style="color:#b58900;">[] </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;">
uncons (x</span><span style="color:#859900;">:</span><span style="color:#657b83;">xs) </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (x, xs)

</span><span style="color:#b58900;">printChars </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">Char</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">printChars idx str </span><span style="color:#859900;">=</span><span style="color:#657b83;"> maybe (return </span><span style="color:#b58900;">()</span><span style="color:#657b83;">) (</span><span style="color:#859900;">\</span><span style="color:#657b83;">(c, str&#39;) </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
    when (idx </span><span style="color:#859900;">`mod` </span><span style="color:#6c71c4;">100000 </span><span style="color:#859900;">== </span><span style="color:#6c71c4;">0</span><span style="color:#657b83;">)
        </span><span style="color:#859900;">$</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Character #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show idx </span><span style="color:#859900;">++ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show c
    printChars (idx </span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">) str&#39;) (uncons str)

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> printChars </span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">$</span><span style="color:#657b83;"> replicate </span><span style="color:#6c71c4;">5000000 </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">x</span><span style="color:#839496;">&#39;
</span></code></pre>
<p>You can compile and run this by saving to a <code>Main.hs</code> file and running
<code>stack Main.hs &amp;&amp; ./Main</code>. On my system, it prints out the following
memory statistics, which from the maximum residency you can see runs
in constant space:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">   2,200,270,200 bytes allocated in the heap
         788,296 bytes copied during GC
          44,384 bytes maximum residency (2 sample(s))
          24,528 bytes maximum slop
               1 MB total memory in use (0 MB lost due to fragmentation)
</span></code></pre>
<p>While constant space is good, the usage of <code>maybe</code> makes this a bit
ugly. This is a common time to use <code>forM_</code> to syntactically clean
things up. So let's give that a shot:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc exec -- ghc -with-rtsopts -s
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">when</span><span style="color:#657b83;">, </span><span style="color:#b58900;">forM_</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">uncons </span><span style="color:#859900;">::</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Maybe</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">, [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">])
uncons </span><span style="color:#b58900;">[] </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;">
uncons (x</span><span style="color:#859900;">:</span><span style="color:#657b83;">xs) </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (x, xs)

</span><span style="color:#b58900;">printChars </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">Char</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">printChars idx str </span><span style="color:#859900;">=</span><span style="color:#657b83;"> forM_ (uncons str) </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">(c, str&#39;) </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
    when (idx </span><span style="color:#859900;">`mod` </span><span style="color:#6c71c4;">100000 </span><span style="color:#859900;">== </span><span style="color:#6c71c4;">0</span><span style="color:#657b83;">)
        </span><span style="color:#859900;">$</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Character #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show idx </span><span style="color:#859900;">++ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show c
    printChars (idx </span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">) str&#39;

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> printChars </span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">$</span><span style="color:#657b83;"> replicate </span><span style="color:#6c71c4;">5000000 </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">x</span><span style="color:#839496;">&#39;
</span></code></pre>
<p>The code is arguablycleaner and easier to follow. However, when I run
it, I get the following memory stats:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">   3,443,468,248 bytes allocated in the heap
     632,375,152 bytes copied during GC
     132,575,648 bytes maximum residency (11 sample(s))
       2,348,288 bytes maximum slop
             331 MB total memory in use (0 MB lost due to fragmentation)
</span></code></pre>
<p>Notice how max residency has balooned up from 42kb to 132mb! And if
you increase the size of the generated list, that number grows. In
other words: we have <em>linear</em> memory usage instead of constant,
clearer something we want to avoid.</p>
<p>The issue is that the implementation of <code>mapM_</code> in <code>Data.Foldable</code> is
not tail recursive, at least for the case of <code>Maybe</code>. As a result,
each recursive call ends up accumulating a bunch of &quot;do nothing&quot;
actions to perform after completing the recursive call, which all
remain resident in memory until the entire list is traversed.</p>
<p>Fortunately, solving this issue is pretty easy: write a tail-recursive
version of <code>forM_</code> for <code>Maybe</code>:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc exec -- ghc -with-rtsopts -s
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">when</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">uncons </span><span style="color:#859900;">::</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Maybe</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">, [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">])
uncons </span><span style="color:#b58900;">[] </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;">
uncons (x</span><span style="color:#859900;">:</span><span style="color:#657b83;">xs) </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (x, xs)

</span><span style="color:#b58900;">forM_Maybe </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Monad m </span><span style="color:#859900;">=&gt; </span><span style="color:#268bd2;">Maybe a </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m </span><span style="color:#859900;">()</span><span style="color:#657b83;">) </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m </span><span style="color:#859900;">()
</span><span style="color:#657b83;">forM_Maybe </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;"> _ </span><span style="color:#859900;">=</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()</span><span style="color:#657b83;">
forM_Maybe (</span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> x) f </span><span style="color:#859900;">=</span><span style="color:#657b83;"> f x

</span><span style="color:#b58900;">printChars </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">Char</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">printChars idx str </span><span style="color:#859900;">=</span><span style="color:#657b83;"> forM_Maybe (uncons str) </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">(c, str&#39;) </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
    when (idx </span><span style="color:#859900;">`mod` </span><span style="color:#6c71c4;">100000 </span><span style="color:#859900;">== </span><span style="color:#6c71c4;">0</span><span style="color:#657b83;">)
        </span><span style="color:#859900;">$</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Character #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show idx </span><span style="color:#859900;">++ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show c
    printChars (idx </span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">) str&#39;

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> printChars </span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">$</span><span style="color:#657b83;"> replicate </span><span style="color:#6c71c4;">5000000 </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">x</span><span style="color:#839496;">&#39;
</span></code></pre>
<p>This implementation once again runs in constant memory.</p>
<p>There's one slight difference in the type of <code>forM_Maybe</code> and <code>forM_</code>
specialized to <code>Maybe</code>. The former takes a second argument of type <code>a -&gt; m ()</code>, while the latter takes a second argument of type <code>a -&gt; m b</code>. This difference is unfortunately necessary; if we try to get back
the original type signature, we have to add an extra action to wipe
out the return value, which again reintroduces the memory leak:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#b58900;">forM_Maybe </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Monad m </span><span style="color:#859900;">=&gt; </span><span style="color:#268bd2;">Maybe a </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m b</span><span style="color:#657b83;">) </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">m </span><span style="color:#859900;">()
</span><span style="color:#657b83;">forM_Maybe </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;"> _ </span><span style="color:#859900;">=</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()</span><span style="color:#657b83;">
forM_Maybe (</span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> x) f </span><span style="color:#859900;">=</span><span style="color:#657b83;"> f x </span><span style="color:#859900;">&gt;&gt;</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()
</span></code></pre>
<p>Try swapping in this implementation into the above program, and once
again you'll get your memory leak.</p>
<h2 id="mono-traversable">mono-traversable</h2>
<p>Back in 2014, I raised this same issue
<a href="https://github.com/snoyberg/mono-traversable/issues/28">about the mono-traversable library</a>,
and ultimately decided to change the type signature of the <code>omapM_</code>
function to the non-overflowing demonstrated above. You can see that
this in fact works:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-7.14 --install-ghc exec --package mono-traversable -- ghc -with-rtsopts -s
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">when</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.MonoTraversable </span><span style="color:#657b83;">(</span><span style="color:#b58900;">oforM_</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">uncons </span><span style="color:#859900;">::</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Maybe</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">, [</span><span style="color:#268bd2;">a</span><span style="color:#657b83;">])
uncons </span><span style="color:#b58900;">[] </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;">
uncons (x</span><span style="color:#859900;">:</span><span style="color:#657b83;">xs) </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (x, xs)

</span><span style="color:#b58900;">printChars </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> [</span><span style="color:#268bd2;">Char</span><span style="color:#657b83;">] </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">printChars idx str </span><span style="color:#859900;">=</span><span style="color:#657b83;"> oforM_ (uncons str) </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">(c, str&#39;) </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
    when (idx </span><span style="color:#859900;">`mod` </span><span style="color:#6c71c4;">100000 </span><span style="color:#859900;">== </span><span style="color:#6c71c4;">0</span><span style="color:#657b83;">)
        </span><span style="color:#859900;">$</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Character #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show idx </span><span style="color:#859900;">++ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show c
    printChars (idx </span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">) str&#39;

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> printChars </span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">$</span><span style="color:#657b83;"> replicate </span><span style="color:#6c71c4;">5000000 </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">x</span><span style="color:#839496;">&#39;
</span></code></pre>
<p>As we'd hope, this runs in constant memory.</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
