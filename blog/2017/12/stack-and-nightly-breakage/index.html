
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Stack and Nightly breakage</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Stack and Nightly breakage">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    

<meta name="og:description" value="An explanation for why Stack 1.5 won&#x27;t build Stackage Nightly snapshots right now">






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Stack and Nightly breakage</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published December  7, 2017</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Stack%20and%20Nightly%20breakage https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;12&#x2F;stack-and-nightly-breakage&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;12&#x2F;stack-and-nightly-breakage&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;12&#x2F;stack-and-nightly-breakage&#x2F;&amp;title=Stack%20and%20Nightly%20breakage" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;12&#x2F;stack-and-nightly-breakage&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;stack-and-nightly-breakage.md">Edit this page on Github</a>
        </i>
      </p>

      <p>I'm sure a number of readers have already seen something about the
situation around Stack and Stackage Nightly/GHC 8.2. I tried to
clarify how this happened on
<a href="https://github.com/commercialhaskell/stack/issues/3624">the relevant Github issue</a>,
plus the
<a href="https://ghc.haskell.org/trac/ghc/ticket/14558">GHC trac ticket</a>, but
thought I'd reshare as a blog post for others who are interested.</p>
<p><strong>EDIT</strong> Right after publishing, I saw that Stack 1.6.1 was released, so you
should probably just run <code>stack upgrade</code>. Keep reading if you're curious on the
bug.</p>
<h2 id="the-problem">The problem</h2>
<p>When the first releases of Stackage Nightly for GHC 8.2.1 started
coming out some months back, they did not work with Stack 1.5.0, due
to an issue with the <code>ghc.cabal</code> file on Hackage. The reason for this
is explained below. We made a point release (Stack 1.5.1) which worked
around the issue temporarily, until Stack 1.6 was released with the
complete fix.</p>
<p>In the interim, GHC 8.2.2 was released, and Stackage Nightly switched
over to it. Contrary to my initial claims: this was a <em>red herring</em>
and unrelated to anything.</p>
<p>On December 4, integer-gmp-1.0.1.0 was uploaded to Hackage, which
reintroduced all of the breakage we had with Stack 1.5.0. Since our
point release had a very targetted workaround (specifically for
<code>ghc.cabal</code>), it did not work around the same bug occurring for
<code>integer-gmp.cabal</code>. Therefore, all versions of Stack before 1.6 will
fail to build a Stackage release with GHC 8.2.</p>
<h2 id="the-workaround">The workaround</h2>
<p>The best &quot;workaround&quot; is just a new release: Stack 1.6 was fortunately
already in release candidate mode, and as I type this up it's going
through the standard release process. By the time I hit publish, the
workaround may be to run <code>stack upgrade</code>.</p>
<p>If that's not the case, you can upgrade to the release candidate by
running:</p>
<pre style="background-color:#fdf6e3;">
<code>stack upgrade --binary-version 1.6.0.20171202
</code></pre><h2 id="cabal-background">Cabal background</h2>
<p>In order to understand the explanation, you should be aware of a few
different things that are all called Cabal:</p>
<ul>
<li>cabal-install, the build tool. This is not relevant to the
explanation below</li>
<li>Cabal the library. This is a normal Haskell library which Stack
depends on, and is used for (among other things) parsing cabal
files.</li>
<li>Cabal the file format. If you open up virtually any cabal file
you'll see a <code>cabal-version: &gt;= 1.10</code> looking field. This is stating
which version of the Cabal file format is being used. New versions
of Cabal-the-library may add new features to the Cabal file
format. The version of the format tracks the library version it was
released with, so that a cabal file stating <code>cabal-version: &gt;= 1.24</code>
can only be parsed by Cabal-the-library 1.24 or later.</li>
</ul>
<p>There was an addition made to Cabal-the-file-format 2.0: a <code>^&gt;=</code>
operator. This operator is not parseable by older versions of Cabal
the library (meaning: Cabal 1.24 or earlier). Stack 1.5 was built
against Cabal-the-library 1.24, and therefore cannot parse any Cabal
files using this new operator.</p>
<p>The Stackage build process prevents any such Cabal files from being
used yet to give tooling (like Stack) a chance to upgrade, something
I've requested of Hackage as well. However, there are some packages
which ship with GHC itself, and which Stackage has no control over in
the creation of a snapshot. This includes packages like <code>base</code>, <code>ghc</code>,
and <code>integer-gmp</code>.</p>
<h2 id="original-breakage">Original breakage</h2>
<p>There's a short explanation (and some code to demonstrate it!) for the
original breakage with GHC 8.2.1 in the pull request:</p>
<p><a href="https://github.com/commercialhaskell/stack/pull/3304/files">https://github.com/commercialhaskell/stack/pull/3304/files</a></p>
<p>Prior to Stack 1.6, there was a bug where Stack would try to get some
metadata about libraries that shipped with GHC from their cabal files
instead of directly from the package database. Historically, this has
never been a problem, which is why it's survived in Stack for so
long. The reason is that, historically, GHC-shipped packages did not
use bleeding-edge features in their cabal files.</p>
<p>When GHC 8.2.1 was released, the <code>ghc.cabal</code> file uploaded to Hackage
did something new: it used a feature of the newly released Cabal 2.0
file format (the <code>^&gt;=</code> operator) and required the new Cabal 2.0
library to parse it. This occurred before Stack had a chance to
upgrade to Cabal-the-library 2.0, and for that matter before
cabal-install 2.0 was released. In other words: at the time the file
was placed on Hackage, no officially released version of any common
tool supported it.</p>
<p>For unrelated reasons, I'd already fixed this bug on master as part of
a refactoring. Strangely enough, that refactoring had to do with
problems with revisions. Thanks to the revision system, it's not
possible to rely on cabal files on Hackage to tell you anything about
GHC-installed packages, since we can't know for certain which revision
was used to build the package. (We'll get to integer-gmp in a moment,
which is slightly worse in this regard.)</p>
<p>The behavior of Stack at this time with regard to GHC-shipped packages
was the following (and this is a bug):</p>
<ul>
<li>If the cabal file cannot be found: ignore the package entirely. This
is necessary for packages like <code>rts</code>.</li>
<li>If the cabal file is found: try to parse it, and fail if the parse
fails.</li>
</ul>
<p>It was this second bullet which caused a problem. When we discovered
this, we released an emergency patch release of Stack to work around
this situation and simply ignore parse failures from <code>ghc.cabal</code>. We
did not embark on a bigger fix because:</p>
<ol>
<li>A bigger fix would involve much more code change, introducing the
chance for regressions</li>
<li>We already had a fix on master, and knew that Stack 1.6 would be
released before GHC 8.4</li>
</ol>
<p>This went out the door, and all users who upgraded to Stack 1.5.1 were
able to use the new Stackage Nightly snapshots based on GHC 8.2.2.</p>
<h2 id="december-4-2017">December 4, 2017</h2>
<p>One of the packages that ships with GHC 8.2 is
<code>integer-gmp-1.0.1.0</code>. Until December 4, this package was not uploaded
to Hackage. As a result, Stack 1.5.1 simply ignored the package
entirely, which worked fine. However, something we didn't anticipate
happened:</p>
<ul>
<li>Months after the GHC 8.2.1 release, <code>integer-gmp-1.0.1.0</code> was
uploaded to Hackage</li>
<li>The cabal file that was uploaded was manually modified to use
Cabal-the-format 2.0 features (again, the <code>^&gt;=</code> operator).</li>
</ul>
<p>You can compare the
<a href="http://hackage.haskell.org/package/integer-gmp-1.0.1.0/integer-gmp.cabal">file on Hackage</a>
with the
<a href="https://github.com/ghc/ghc/blob/ghc-8.2.2-release/libraries/integer-gmp/integer-gmp.cabal">file on Github</a>. It's
unclear what the motivation was behind this modification, but this
modification is what broke Stack 1.5.1 and GHC 8.2.</p>
<p>Before this upload, the missing <code>integer-gmp.cabal</code> file was simply
ignored by Stack. Once it was uploaded, Stack (again, as a bug) tries
to parse it, fails, and gives up.</p>
<h2 id="the-future">The future</h2>
<p>Obviously there was a bug in Stack that needed to be fixed, and has
been fixed. However, the irregularities around the <code>ghc.cabal</code> and
<code>integer-gmp.cabal</code> files are a little troubling, and make it
difficult to predict future behavior. Hopefully some new policies from
GHC HQ will address these concerns.</p>
<p>And while this case is a bug in Stack, I want to clarify a general
point. It is entirely expected that over time, older releases of Stack
will not be able to use newer Stackage snapshots. At some point in the
future, Stackage will allow Cabal 2.0-formatted cabal files into
snapshots, and then by design Stack 1.5 and earlier will be unable to
parse those files. That's unfortunate, but expected. What's unexpected
in this case was that</p>
<ol>
<li>These cabal files slipped into a snapshot through the back door
(GHC's package database) so quickly, before Stack 1.6 was out the
door</li>
<li>That actions taken post-GHC release (a new upload of
integer-gmp.cabal) could affect existing snapshots.</li>
</ol>
<p>Both points will hopefully be hit both by the fixes that landed on
Stack 1.6 ensuring less eager parsing of cabal files, and changes in
GHC HQ policy.</p>
<h2 id="summary">Summary</h2>
<ol>
<li>There's a bug in Stack, triggered by new behavior not seen before
by GHC</li>
<li>That bug affects reproducibility, because an upload to Hackage in
the future (or a revision for that matter) can break existing build
plans</li>
<li>This bug is fixed on master fully (AFAICT, we've added an
integration test to check for regressions)</li>
<li>Instead of putting out another emergency Stack 1.5 patch for
integer-gmp.cabal, we're going to get Stack 1.6 out the door ASAP</li>
</ol>
<p>I hope that clarifies. This is definitely an unfortunate situation,
and I know it's screwed up people's development, so my apologies on
that front. I hope for all our sakes (mine included!) that the
situation is more stable going forward.</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
