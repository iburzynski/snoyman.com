
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Playing with lens-aeson</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Playing with lens-aeson">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Playing with lens-aeson</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published May 29, 2017</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Playing%20with%20lens-aeson https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;05&#x2F;playing-with-lens-aeson&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;05&#x2F;playing-with-lens-aeson&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;05&#x2F;playing-with-lens-aeson&#x2F;&amp;title=Playing%20with%20lens-aeson" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2017&#x2F;05&#x2F;playing-with-lens-aeson&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;playing-with-lens-aeson.md">Edit this page on Github</a>
        </i>
      </p>

      <p>At LambdaConf last week, Tony Morris convinced me I should take
another stab at getting more comfortable with lens, and after chatting
with a few other people (including at least Chris Allen), I decided
that the
<a href="https://www.stackage.org/package/lens-aeson">lens-aeson</a>/JSON parsing
use case would be a good at forcing me to play with more of the lens
ecosystem than I have previously.</p>
<p>This is not a normal blog post for me. I'm not an expert (or even
competent) on the topic of lens. In fact, odds are no one should read
this blog post. Really consider it me thinking out loud, and
obnoxiously doing so on my blog. I'll excuse the weird nature of this
by saying I'm running on little sleep, and I'm bored in an airport and
on an airplane.</p>
<hr />
<p>Let's start off with a simple JSON file containing color names and
values that looks like this:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">[
    {
        </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">: </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">red</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">,
        </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">value</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">: </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">#f00</span><span style="color:#839496;">&quot;
    </span><span style="color:#657b83;">},
    {
        </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">: </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">black</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">,
	    </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">value</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">: </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">#000</span><span style="color:#839496;">&quot;
    </span><span style="color:#657b83;">}
]
</span></code></pre>
<p>This is a relatively simple file format, with an array of individual
objects, and each object having the same keys. We want to get the
names of all the colors from this, ignoring the values. Let's start
off by implementing such a program using an explicit <code>FromJSON</code>
instance, which is probably the most obvious thing to do based on the
lens documentation.</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Text</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B

data </span><span style="color:#cb4b16;">Color </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">Color</span><span style="color:#657b83;"> { colorName </span><span style="color:#859900;">:: !</span><span style="color:#cb4b16;">Text</span><span style="color:#657b83;"> }

</span><span style="color:#859900;">instance </span><span style="color:#268bd2;">FromJSON Color </span><span style="color:#859900;">where</span><span style="color:#657b83;">
  parseJSON </span><span style="color:#859900;">=</span><span style="color:#657b83;"> withObject </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Color</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">o </span><span style="color:#859900;">-&gt; </span><span style="color:#cb4b16;">Color </span><span style="color:#859900;">&lt;$&gt;</span><span style="color:#657b83;"> o </span><span style="color:#859900;">.: </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;
  </span><span style="color:#859900;">case</span><span style="color:#657b83;"> eitherDecodeStrict&#39; bs </span><span style="color:#859900;">of
    </span><span style="color:#cb4b16;">Left</span><span style="color:#657b83;"> e </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error e
    </span><span style="color:#cb4b16;">Right</span><span style="color:#657b83;"> colors </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> map colorName colors
</span></code></pre>
<p>This is pretty straightforward: we define a data type <code>Color</code>, which
contains the fields we care about (here, just the name of the
color). Then we declare a <code>FromJSON</code> instance which parses out the
<code>color</code> key. In our <code>main</code> function, we read the raw bytes, and use
<code>eitherDecodeStrict'</code> to parse the JSON into a <code>Value</code> and then use
our <code>FromJSON</code> instance to convert that <code>Value</code> into a list of <code>Color</code>
values. We then apply <code>colorName</code> to each value in that list to
extract the name, and print the list.</p>
<p>That works, but it's far from inspiring. We're declaring a <code>Color</code>
datatype simply for the purpose of writing a typeclass instance. But
it feels pretty heavyweight to have to declare a data type and make a
typeclass instance for just one use site. Let's try what I'd consider
the next most obvious approach: work directly on the <code>Value</code> data
type's constructors:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Text</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Vector </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">V
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.HashMap.Strict </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">HashMap

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;
  </span><span style="color:#859900;">case</span><span style="color:#657b83;"> eitherDecodeStrict&#39; bs </span><span style="color:#859900;">of
    </span><span style="color:#cb4b16;">Left</span><span style="color:#657b83;"> e </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error e
    </span><span style="color:#cb4b16;">Right</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">Array</span><span style="color:#657b83;"> array) </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
      colors </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">V</span><span style="color:#859900;">.</span><span style="color:#657b83;">forM array </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">v </span><span style="color:#859900;">-&gt;
        case</span><span style="color:#657b83;"> v </span><span style="color:#859900;">of
          </span><span style="color:#cb4b16;">Object</span><span style="color:#657b83;"> o </span><span style="color:#859900;">-&gt;
            case </span><span style="color:#cb4b16;">HashMap</span><span style="color:#859900;">.</span><span style="color:#657b83;">lookup </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;"> o </span><span style="color:#859900;">of
              </span><span style="color:#cb4b16;">Nothing </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Didn&#39;t find color key</span><span style="color:#839496;">&quot;
              </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">String</span><span style="color:#657b83;"> c) </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> return c
              </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> v&#39; </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Expected a String, got: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show v&#39;
          _ </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Expected an object, got: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show v
      print colors
    </span><span style="color:#cb4b16;">Right</span><span style="color:#657b83;"> v </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> error </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Unexpected top level type: </span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show v
</span></code></pre>
<p>This works, but is thoroughly unappetizing. We need to take into
account a lot of corner cases and explicitly handle looping over the
<code>Vector</code>. It's unpleasant, and for a non-toy example, would be
downright tedious.</p>
<p>Let's try to avoid the tedium, and if you read my intro paragraph, you
won't be surprised to hear that the answer I'm proposing is
<code>lens-aeson</code>.</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs^</span><span style="color:#859900;">..</span><span style="color:#657b83;">values</span><span style="color:#859900;">.</span><span style="color:#657b83;">key </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String
</span></code></pre>
<p>This code looks almost too short to work, but it produces exactly the
same output as before for our <code>colors.json</code> file. To see how it works:</p>
<ul>
<li>We don't need to do any explicit parsing of our <code>ByteString</code>
value. <code>lens-aeson</code> contains a number of typeclasses for matching
JSON values, and provides instances for <code>ByteString</code>, <code>Text</code>, and
<code>String</code> that will perform an initial parse to a <code>Value</code> for you
automatically.</li>
<li>The <code>^..</code> operator comes from the <code>lens</code> package, which is a synonym
for <code>toListOf</code>. As you might imagine, it converts <em>something</em> into a
list. Our <code>^..</code> operator will take the value on the left hand side
(<code>bs</code> here) and apply the <code>Fold</code> on the right to it, collecting the
results into a list.</li>
<li>Now we need to understand how we construct our <code>Fold</code>. We start off
with <code>values,</code> which will match a JSON array and provide all of the
values inside of it.</li>
<li>Next we compose with the <code>key &quot;color&quot;</code> <code>Fold</code>, which takes a
<code>Value</code>, checks that it is an <code>Object</code>, and looks up the given key,
in this case <code>&quot;color&quot;</code>.</li>
<li>Finally, we use the <code>_String</code> <code>Fold</code> to check that we have a string
value (as opposed to something like a number or a boolean) and
returns it.</li>
</ul>
<p>The behavior of this isn't exactly identical to our previous
versions. In particular, if there are values in our array that don't
match our requirements, they'll simply be dropped instead of producing
an error. Whether this is acceptable for your case is up to you. And
I'm hoping that someone reading this post will provide a good example
of how to do the error-checking version with <code>lens-aeson</code>.</p>
<h2 id="not-just-a-fold">Not just a <code>Fold</code></h2>
<p>Above, I mentioned the term <code>Fold</code> many times. A <code>Fold</code> is one kind of
<em>optic</em> from the lens package, which &quot;allows you to extract multiple
results from a container.&quot; However, if you're familiar with lens, you
may know that optics form a hierarchy.</p>
<p><strong>NOTE</strong> An <em>optic</em> is a more general term that encompasses a lot of
the types in the lens package, like lenses, foldables, prisms,
traversables, isos, getters, etc. Because of how optics are
structured, they compose together nicely. And because of how the
typeclasses are structured, optics have a nice subtyping system, which
I'm hinting at here.</p>
<p>For example, a <code>Traversal</code> is a generalization of a <code>Fold</code> which also
allows us to &quot;traverse over a structure and change out its contents
with monadic side-effects.&quot; Our <code>values</code> <code>Fold</code> isn't just a
<code>Fold</code>. It allows us to also update all of the values inside the
array, making it a valid <code>Traversal</code>. Let's see how we can use that:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do
  let</span><span style="color:#657b83;"> bs </span><span style="color:#859900;">= </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">[1,2,3]</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#cb4b16;">ByteString</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs &amp; values</span><span style="color:#859900;">.</span><span style="color:#657b83;">_Number </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> (</span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)
</span></code></pre>
<p>Instead of reading our <code>ByteString</code> from a file, we're now defining
our <code>bs</code> value in our Haskell code, giving it the JSON representation
of the array of numbers 1, 2, and 3.</p>
<p>We then take our <code>ByteString</code> and use the <code>&amp;</code> operator, which is
reverse function application. This means that we will apply whatever's
on the right hand side of <code>&amp;</code> to our <code>ByteString</code> on the left. Let's
look at that function:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">values</span><span style="color:#859900;">.</span><span style="color:#657b83;">_Number </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> (</span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)
</span></code></pre>
<p>The <code>%~</code> operator will apply some modification function using a
<code>Setter</code>. And guess what: a <code>Traversal</code> is a generalization of a
<code>Setter</code>, so we can use a <code>Traversal</code>. As we said, <code>values</code> is a
<code>Traversal</code>. <code>_Number</code> is also a <code>Traversal</code>, so their composition
makes a <code>Traversal</code>. And then we apply our <code>+ 1</code> function inside of
it.</p>
<p>So to sum up, our <code>bs &amp; values._Number %~ (+ 1)</code> expression will do
the following:</p>
<ul>
<li>Parse the raw bytestring value in <code>bs</code> into a JSON <code>Value</code></li>
<li>Inspect that value and see if it's an array</li>
<li>For each element in that array, check if it's a number</li>
<li>If it's a number, add 1 to it</li>
<li>Finally, take the newly created <code>Value</code> and render it back into a
bytestring value</li>
</ul>
<p>That's quite the power-to-weight ratio. I recommend writing the same
thing without lens for comparison.</p>
<h2 id="not-just-a-traversal">Not just a <code>Traversal</code></h2>
<p>The same way a <code>Traversal</code> is a generalization of a <code>Fold</code>, a <code>Prism</code>
is a generalization of a <code>Traversal</code>. While a <code>Traversal</code> represents
the ability to look inside a value, find 0 or more values of a given
type, and either get them (the <code>Fold</code> power) or modify them (the
<code>Traversal</code> power), a <code>Prism</code> specificies that it will have <em>exactly</em>
0 or 1 values, and that, given one value of the target type, you
create the original type.</p>
<p>Did that sound confusing? I certainly think so. So let's say it
another way: a <code>Prism</code> is an optic version of a data constructor. When
you have a sum type <code>Either a b</code>, you can always get exactly 0 or 1
<code>a</code> values (0 if the value is <code>Right</code>, 1 if the value is <code>Left</code>). And,
given an <code>a</code> value, you can always construct a value of type <code>Either a b</code>.</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Test.Hspec

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> hspec </span><span style="color:#859900;">$ do</span><span style="color:#657b83;">
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">constructs with _Left</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> ^</span><span style="color:#859900;">.</span><span style="color:#657b83;"> re _Left) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Left </span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Either Int String</span><span style="color:#657b83;">)
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">constructs with _Right</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">hello</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;"> ^</span><span style="color:#859900;">.</span><span style="color:#657b83;"> re _Right) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Right </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">hello</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Either Int String</span><span style="color:#657b83;">)
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">traverses with _Left</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Left </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> &amp; _Left </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> (</span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Left </span><span style="color:#6c71c4;">2 </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Either Int String</span><span style="color:#657b83;">)
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">traverse can do nothing</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Right </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">hello</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;"> &amp; _Left </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> (</span><span style="color:#859900;">+ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;">)) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Right </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">hello</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Either Int String</span><span style="color:#657b83;">)
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">folds with _Left</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Left </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> ^</span><span style="color:#859900;">..</span><span style="color:#657b83;"> _Left) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    [</span><span style="color:#6c71c4;">1 </span><span style="color:#859900;">:: </span><span style="color:#cb4b16;">Int</span><span style="color:#657b83;">]
  it </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">folds with _Right</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Left </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> ^</span><span style="color:#859900;">..</span><span style="color:#657b83;"> _Right) </span><span style="color:#859900;">`shouldBe`</span><span style="color:#657b83;">
    (</span><span style="color:#b58900;">[] </span><span style="color:#859900;">::</span><span style="color:#657b83;"> [</span><span style="color:#b58900;">()</span><span style="color:#657b83;">])
</span></code></pre>
<p>So apparently, if you're totally bought in on the lens ecosystem,
you're free to never use your data constructors again and just use
<code>re</code>. But anyway, we were dealing with JSON data; can we construct a
simple JSON value like this? Sure.</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Vector </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">V

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">=</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> ^</span><span style="color:#859900;">.</span><span style="color:#657b83;"> re _Number</span><span style="color:#859900;">.</span><span style="color:#657b83;">to (</span><span style="color:#cb4b16;">V</span><span style="color:#859900;">.</span><span style="color:#657b83;">replicate </span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">)</span><span style="color:#859900;">.</span><span style="color:#657b83;">re _Array
</span></code></pre>
<p>The <code>to</code> function converts a normal functions from <code>a</code> to <code>b</code> into an
optic that does the same thing, a <code>Getter a b</code>. More idiomatically (I
think), we'd actually use the type variables <code>s</code> and <code>a</code> and get <code>to :: (s -&gt; a) -&gt; Getter s a</code>.</p>
<p>This was actually more detailed on lens itself than I intended to get
here, but since this blog post is just a forcing function for me to
explore things and not actually useful for anyone else in the world, I
guess that's OK.</p>
<h2 id="more-random-fun">More random fun</h2>
<p>Alright, can I upper case all of the color names? Sure:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Vector </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">V

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs &amp; values</span><span style="color:#859900;">.</span><span style="color:#657b83;">key </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String </span><span style="color:#859900;">%~ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">toUpper
</span></code></pre>
<p>Now let's get a bit trickier: can I create an <em>additional</em> field
<code>color-upper</code> with this upper cased version? I have no idea if this is
idiomatic lens code, but it certainly works:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Vector </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">V

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs &amp; values</span><span style="color:#859900;">.</span><span style="color:#657b83;">_Object </span><span style="color:#859900;">%~</span><span style="color:#657b83;">
    (</span><span style="color:#859900;">\</span><span style="color:#657b83;">hm </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> hm &amp; at </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color-upper</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">.~</span><span style="color:#657b83;">
      (hm^</span><span style="color:#859900;">?</span><span style="color:#657b83;">at </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">folded</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String</span><span style="color:#859900;">.</span><span style="color:#657b83;">to </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">toUpper</span><span style="color:#859900;">.</span><span style="color:#657b83;">re _String))
</span></code></pre>
<p>That's a lot to unpack for me. First, I'm using <code>bs &amp; values._Object %~ ...</code> to say &quot;look inside the bytestring, treat it as JSON, look for
an array, and find every object in that array and treat it as a
<code>HashMap Text Value</code>, and modify each hashmap using the ...&quot; It's the
<code>...</code> that I find confusing.</p>
<p>Next, we do <code>hm &amp; at &quot;color-upper&quot; .~ ...</code>, which says &quot;I want to set
the value in the hashmap at the key <code>color-upper</code> to the <code>Maybe Value</code>
value I'm giving you. Finally, we get our <code>Maybe Value</code> value with the
rest of that expression, which reads:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">hm^</span><span style="color:#859900;">?</span><span style="color:#657b83;">at </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">folded</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String</span><span style="color:#859900;">.</span><span style="color:#657b83;">to </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">toUpper</span><span style="color:#859900;">.</span><span style="color:#657b83;">re _String
</span></code></pre>
<p>This reads to me as:</p>
<ul>
<li>Take <code>hm</code></li>
<li>Give me the first value that succeeds (<code>^?</code>), or <code>Nothing</code> if no
value gets grabbed</li>
<li>Look up the <code>&quot;color&quot;</code> key</li>
<li>Flatten out that <code>Maybe Value</code> into just a <code>Value</code></li>
<li>Check that it's a string</li>
<li>Convert it to upper case</li>
<li>Wrap it back in a <code>String</code> constructor using <code>re _String</code></li>
</ul>
<p>By way of contrast, I can write the same functionality the non-lens way with:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#859900;">\</span><span style="color:#657b83;">hm </span><span style="color:#859900;">-&gt;
  case </span><span style="color:#cb4b16;">HashMap</span><span style="color:#859900;">.</span><span style="color:#657b83;">lookup </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;"> hm </span><span style="color:#859900;">of
    </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">String</span><span style="color:#657b83;"> color) </span><span style="color:#859900;">-&gt; </span><span style="color:#cb4b16;">HashMap</span><span style="color:#859900;">.</span><span style="color:#657b83;">insert
      </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color-upper</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
      (</span><span style="color:#cb4b16;">String</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">toUpper color))
      hm
    _ </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> hm
</span></code></pre>
<p>For me personally, I find this version easier to read, but I'm also a
lens usage novice. Maybe I just need to force myself to write
airplane-powered rambling lens blog posts more often (or maybe write
some real code).</p>
<p>Going for something much simpler, let's just delete all of the <code>value</code>
keys:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs &amp; values</span><span style="color:#859900;">.</span><span style="color:#657b83;">_Object </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> sans </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">value</span><span style="color:#839496;">&quot;
</span></code></pre><h3 id="indexed">Indexed</h3>
<p>I wanted to play with indexed optics a bit. My goal had been to modify
the following code:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-8.12 script
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Lens
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Aeson.Lens
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">B

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs ^</span><span style="color:#859900;">..</span><span style="color:#657b83;"> values</span><span style="color:#859900;">.</span><span style="color:#657b83;">key </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String
</span></code></pre>
<p>So that it printed a pair of the index in the array that the color
appears at, and the color itself. Unfortunately, I couldn't figure out
how to make that work. One thing I got was:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs ^@</span><span style="color:#859900;">..</span><span style="color:#657b83;"> values
</span></code></pre>
<p>But this just keeps the entire object, not the string inside the
<code>color</code> key like I wanted. The following is a bit closer, but (1) it
keeps <code>Nothing</code> values in the result instead of just removing them
(like a <code>mapMaybe</code> would) and (2) doesn't feel idiomatic:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> (bs ^@</span><span style="color:#859900;">..</span><span style="color:#657b83;"> values) &amp; each</span><span style="color:#859900;">.</span><span style="color:#657b83;">_2 </span><span style="color:#859900;">%~</span><span style="color:#657b83;"> (^</span><span style="color:#859900;">?</span><span style="color:#657b83;"> key </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String)
</span></code></pre>
<p>Then I discovered the <code>pre</code> function, which let me do the following
with identical output to the former:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
  bs </span><span style="color:#859900;">&lt;- </span><span style="color:#cb4b16;">B</span><span style="color:#859900;">.</span><span style="color:#657b83;">readFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">colors.json</span><span style="color:#839496;">&quot;</span><span style="color:#657b83;">
  print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> bs ^@</span><span style="color:#859900;">..</span><span style="color:#657b83;"> values</span><span style="color:#859900;">.</span><span style="color:#657b83;">pre (key </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">color</span><span style="color:#839496;">&quot;</span><span style="color:#859900;">.</span><span style="color:#657b83;">_String)
</span></code></pre>
<p>It does seem like I'm likely missing something obvious to remove drop
the <code>Nothing</code> values and remove the <code>Maybe</code> wrapping entirely, but
unfortunately I couldn't figure it out.</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
