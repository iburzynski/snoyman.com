
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Mismatched global packages</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Mismatched global packages">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    

<meta name="og:description" value="How GHC can ship packages that are different than what&#x27;s on Hackage, how this impacts Stack, and how to do better">






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Mismatched global packages</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published January 24, 2019</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Mismatched%20global%20packages https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2019&#x2F;01&#x2F;mismatched-global-packages&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2019&#x2F;01&#x2F;mismatched-global-packages&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2019&#x2F;01&#x2F;mismatched-global-packages&#x2F;&amp;title=Mismatched%20global%20packages" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2019&#x2F;01&#x2F;mismatched-global-packages&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;mismatched-global-packages.md">Edit this page on Github</a>
        </i>
      </p>

      <p>This blog post covers an issue with how packages are shipped with GHC, and an edge case of how this can negatively interact with Stack. The overall point about the package contents mismatch will apply more broadly, but I'm mostly focused in this post on how to better handle this in Stack.</p>
<h2 id="intro">Intro</h2>
<p>GHC ships with a few <em>wired in</em> packages which cannot be reinstalled. Examples are <code>ghc</code>, <code>base</code>, and <code>template-haskell</code>. The situation with these for all build tools is simple: the GHC version determines the package version.</p>
<p>There are also packages which are not shipped with GHC at all. All build tools get to determine whatever version of these packages they want, assuming compatibility with the GHC version and the packages that are wired in with it.</p>
<p>There's an in-between category: packages like <code>process</code> and <code>transformers</code> are shipped with GHC, but can also be easily reinstalled from Hackage. Some tools may decide to eagerly recompile the latest version of them. Stackage takes a different approach: in order to avoid invalidating the <code>ghc</code> package, it avoids recompiling any of these packages, and sticks by default with the <em>global version</em>. Stack is designed to work with that.</p>
<h2 id="when-recompilation-happens">When recompilation happens</h2>
<p>Suppose you have the following <code>stack.yaml</code> file:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#268bd2;">resolver</span><span style="color:#657b83;">: </span><span style="color:#268bd2;">ghc-8.6.3
packages</span><span style="color:#657b83;">:
- </span><span style="color:#6c71c4;">.
</span></code></pre>
<p>And suppose your local package depends on the <code>unix</code> package. On non-Windows systems, <code>unix</code> ships with GHC. Running <code>stack build</code> will therefore result in only building the local package, not <code>unix</code>, since <code>unix</code> is in the global package database.</p>
<p>Now let's suppose that, instead of using a <code>ghc-8.6.3</code> resolver, you use an LTS Haskell resolver:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#268bd2;">resolver</span><span style="color:#657b83;">: </span><span style="color:#268bd2;">lts-13.4
packages</span><span style="color:#657b83;">:
- </span><span style="color:#6c71c4;">.
</span></code></pre>
<p>Same thing: LTS Haskell snapshots never specify versions of global packages. Instead, they are implicitly inherited from the GHC global package database. In a few specific cases (like the <code>stack init</code> command), we want to avoid requiring that GHC is already installed, so we instead use a <a href="https://github.com/commercialhaskell/stackage-content/blob/master/stack/global-hints.yaml">global hints</a> file to specify the versions of packages which ship with GHC.</p>
<p>The <code>unix</code> package depends on the <code>time</code> package. Let's suppose your <code>stack.yaml</code> file instead said:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#268bd2;">resolver</span><span style="color:#657b83;">: </span><span style="color:#268bd2;">lts-13.4
packages</span><span style="color:#657b83;">:
- </span><span style="color:#6c71c4;">.
</span><span style="color:#268bd2;">extra-deps</span><span style="color:#657b83;">:
- </span><span style="color:#2aa198;">time-1.9.2
</span></code></pre>
<p>And suppose your local package depends on both <code>unix</code> and <code>time</code>. If you run <code>stack build</code>, Stack has three basic options:</p>
<ol>
<li>Only recompile <code>time</code>, but keep the original <code>unix</code>. That's a bad idea: you'll now have two different versions of the datatypes in the <code>time</code> package floating around. People may remember extremely confusing error messages about &quot;cannot match <code>ByteString</code> with <code>ByteString</code>&quot; or similar. It comes from this kind of a build plan.</li>
<li>Fail to compile at all. The <code>unix</code> in the global database is &quot;invalidated&quot; by the presence of a newly compiled <code>time</code>, and your package depends on <code>unix</code>. Just give up.</li>
<li>Automatically add an <code>extra-dep</code> version of <code>unix</code> to the build plan, and recompile both <code>time</code> and <code>unix</code>.</li>
</ol>
<p>(1) is a really bad idea, and (2) is pretty annoying. So today, Stack follows (3), and automatically/implicitly adds the invalidated global packages to the build plan.</p>
<h2 id="where-do-global-packages-come-from">Where do global packages come from?</h2>
<p>Look at the following simplified output of a command describing the global <code>process</code> package shipped with GHC 8.6.3:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">$ stack --resolver ghc-8.6.3 exec -- ghc-pkg describe process
name: process
version: 1.6.3.0
...
depends:
    base-4.12.0.0 deepseq-1.4.4.0 directory-1.3.3.0 filepath-1.4.2.1
    unix-2.7.2.2
</span></code></pre>
<p>Important bits:</p>
<ul>
<li>We're using <code>process-1.6.3.0</code></li>
<li>We're depending on <code>base-4.12.0.0</code></li>
</ul>
<p>Now check out the <code>process.cabal</code> file for <code>process-1.6.3.0</code> <a href="https://hackage.haskell.org/package/process-1.6.3.0/revision/0.cabal">on Hackage</a> and <a href="https://github.com/haskell/process/blob/v1.6.3.0/process.cabal#L77">on Github</a>. You'll notice the following bound:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">    build-depends: base      &gt;= 4.4 &amp;&amp; &lt; 4.12,
</span></code></pre>
<p>These pieces of information are contradictory: the cabal file says <code>base &lt; 4.12</code>, but GHC ships with this version of <code>process</code> and <code>base-4.12.0.0</code>! How is this possible?</p>
<p>Well, it turns out, when GHC says it has <code>process-1.6.3.0</code>, it's <em>not</em> code that's downloaded from Hackage. Instead, it's established via a submodule. Specifically, you can <a href="https://github.com/ghc/ghc/tree/ghc-8.6.3-release/libraries">see on Github</a> that GHC 8.6.3 is using <code>process</code> at Git commit <a href="https://github.com/haskell/process/tree/36a3ad577e31e8c3336c7464b252fc2c9b01a20c">36a3ad5</a>. By contrast, the <code>v1.6.3.0</code> tag points to Git commit <a href="https://github.com/haskell/process/commit/7c0b58141290b50a338bf391adc0a8c43513165b">7c0b5814</a>.</p>
<p>This isn't a recent revelation, and not only my revelation. I peripherally knew about this, but I've heard of three different people discovering this problem in the past month. I'm writing this blog post to point out how it negatively affects Stack, and what to do about it.</p>
<h2 id="how-it-breaks-stack">How it breaks Stack</h2>
<p><code>process</code> depends on the <code>directory</code> package. Let's use an extra-dep to provide a new version of <code>directory</code>, and then try to build:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">$ cat stack.yaml 
resolver: ghc-8.6.3
packages: []
extra-deps:
- directory-1.3.3.1
$ stack build process

Error: While constructing the build plan, the following exceptions were encountered:

In the dependencies for process-1.6.3.0:
    base-4.12.0.0 from stack configuration does not match &gt;=4.4 &amp;&amp; &lt;4.12  (latest matching version is 4.11.1.0)
needed since process is a build target.
</span></code></pre>
<p>Well that's darn confusing. I changed a version of <code>directory</code>, and suddenly <code>process</code> has a bounds error?!? This makes perfect sense given the above (though it's certainly unsatisfying):</p>
<ul>
<li>GHC ships with a <em>different version</em> of <code>process-1.6.3.0</code></li>
<li><code>process</code> needs to be recompiled when we change the <code>directory</code> package</li>
<li>Stack assumes that it can simply use <code>process-1.6.3.0</code> to replace the global <code>process</code> package</li>
<li>However, the <code>process</code> on Hackage differs slightly from the one shipped with GHC</li>
</ul>
<p>This is a relatively simple problem which results in an annoying bounds error, and can be easily fixed by adding a new <code>process</code> extra-dep. However, other problems are much more severe:</p>
<ul>
<li>What if GHC is compiling one of these packages with a special cabal flag? We won't be able to reproduce that. In fact, there are comments in the Stack code base about this already.</li>
<li>What if the code on Hackage is <em>fundamentally</em> different from what's shipped with GHC? We could get silent but significant behavior changes.</li>
</ul>
<h2 id="solution-make-no-assumptions">Solution: make no assumptions</h2>
<p>The core problem here is that Stack assumes <code>process-1.6.3.0</code> provided by GHC is the same as what's on Hackage. That assumption plays itself out in our selection of option (3) above. I propose: get rid of the assumption! Instead, move to option (2): if we replace a global package, prune all global packages that depend on it, and require adding those as explicit <code>extra-dep</code> entries.</p>
<p>This will break some existing build plans, but I'm proposing this change for Stack 2.0, which is already allowing some slight breakage along those lines. This will add some annoyance to users, but with the result of more clarity on what's happening in a build plan. And perhaps we can even make an error message for these cases which points right at this post!</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
