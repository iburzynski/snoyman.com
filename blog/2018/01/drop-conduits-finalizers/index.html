
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Drop Conduit&#x27;s Finalizers?</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Drop Conduit&#x27;s Finalizers?">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    

<meta name="og:description" value="Time to ask a really hard question: is it time to remove Conduit&#x27;s finalizer concept from the library?">






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Drop Conduit&#x27;s Finalizers?</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published January  3, 2018</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Drop%20Conduit%27s%20Finalizers%3F https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2018&#x2F;01&#x2F;drop-conduits-finalizers&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2018&#x2F;01&#x2F;drop-conduits-finalizers&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2018&#x2F;01&#x2F;drop-conduits-finalizers&#x2F;&amp;title=Drop%20Conduit%27s%20Finalizers%3F" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2018&#x2F;01&#x2F;drop-conduits-finalizers&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;drop-conduits-finalizers.md">Edit this page on Github</a>
        </i>
      </p>

      <p>tl;dr: I'm thinking of dropping finalizers from Conduit. If you have
use cases that necessitate finalizers, <strong>please share them with
me</strong>. <a href="https://github.com/snoyberg/conduit/issues/343">Github issue for examples.</a></p>
<p>People who have followed the history of the Conduit library will
likely be aware of how passionately I've argued for the necessity of a
finalizer concept. For those unaware: when you have a Conduit pipeline
like the following:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">runConduitRes </span><span style="color:#859900;">$ do</span><span style="color:#657b83;">
  sourceFile input </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> takeCE </span><span style="color:#6c71c4;">100 </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> sinkFile output
  </span><span style="color:#93a1a1;">-- lots of other stuff
</span></code></pre>
<p>Without finalizers, the file <code>input</code> will remain open until we exit
the <code>runConduitRes</code> call (unless the file is less than 100 bytes). The
reason is that, in a pipeline, downstream is always in control. When
<code>takeCE</code> stops consuming from <code>sourceFile</code>, <code>sourceFile</code> will never be
called again. Finalizers allow <code>sourceFile</code> to tell downstream &quot;hey,
if you don't call me back, please close up my file.&quot; And so they're a
Good Thing.</p>
<p>They're also a Complicated Thing. The internals of Conduit include a
lot of complexity around finalizers. As a user, you hardly ever see
it, which is by design. But if you start dealing with the guts of
Conduit, it's there. (Have a look at
<a href="https://github.com/snoyberg/conduit/commit/e7f0cb77987a23c3d259e413efa33f45f7069f79">this commit</a>
to get an idea.)</p>
<p>They also complicate the story around associativity of Conduit
significantly. Or more to the point: without finalizers, we can get
properly behaving associative and identity laws*. With finalizers, we
have to start making up claims about reordering of finalizers. Which
is almost always fine in practice, but clearly not a mathematical law.</p>
<p>* Caveats: I've never written the proof of it completely. Also, it
relies on using the type paramter on the <code>Pipe</code> type to eliminate
leftovers, but leftovers are not a topic I'm raising right now.</p>
<p>None of this is new information; so why am I writing this blog post
now? The first is that I'm already working on a breaking change to
Conduit to standardize naming and eliminate some legacy type and
operator names. See
<a href="https://github.com/snoyberg/conduit/issues/283">the discussion</a> and
<a href="https://github.com/snoyberg/conduit/pull/338/files">initial comparison</a>
for more details. This naturally leads me to ask related questions.</p>
<p>More to the point: after having worked with Conduit for years, my
initial concerns about prompt finalization seem to have been
overzealous. While the code above <em>can</em> happen, it doesn't happen that
often in practice, and even that level of resource overholding isn't
usually that bad. Regardless, if the situation really does call for
guaranteed promptness, we can still get it (a trick I'm fairly certain
I learned from Gabriel Gonzalez):</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">runConduitRes </span><span style="color:#859900;">$ do</span><span style="color:#657b83;">
  withSourceFileResource input </span><span style="color:#859900;">$ \</span><span style="color:#657b83;">src </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;">
    src </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> takeCE </span><span style="color:#6c71c4;">100 </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> sinkFile output
  </span><span style="color:#93a1a1;">-- lots of other stuff
</span></code></pre>
<p>It's not quite as elegant, but works well enough. And again: I'm hard
pressed to think of real life code I've written that would really
warrant this. <strong>BIG REQUEST</strong> If you have examples of Conduit-using
code where finalizers are vital, please send me examples.</p>
<p>While on the one hand, making this change would be to admit I've
sucked up huge amounts of extra work in maintaining Conduit over the
years, I'd be very happy to cut the dead weight now, unless someone
out there wants to convince me otherwise. Feel free to discuss
wherever desired, but the main discussion I'll be sure to follow will
be
<a href="https://github.com/snoyberg/conduit/issues/343">conduit issue #343</a>.</p>
<p>There are some natural follow-on questions that come from this also,
which I'll likely broach in a later blog post. To give a taste and
hopefully encourage some thoughts from others:</p>
<ul>
<li>Should the <code>Pipe</code> types upstream finalizer concept disappear as
well?</li>
<li>Can we remove the <code>Leftover</code> data constructor from <code>Pipe</code>, making
<code>Pipe</code> a full category, and then move the tracking of leftovers to
<code>ConduitM</code> and its codensity approach?</li>
</ul>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
