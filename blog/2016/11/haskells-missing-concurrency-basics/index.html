
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Haskell&#x27;s Missing Concurrency Basics</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Haskell&#x27;s Missing Concurrency Basics">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Haskell&#x27;s Missing Concurrency Basics</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published November 16, 2016</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Haskell%27s%20Missing%20Concurrency%20Basics https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;11&#x2F;haskells-missing-concurrency-basics&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;11&#x2F;haskells-missing-concurrency-basics&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;11&#x2F;haskells-missing-concurrency-basics&#x2F;&amp;title=Haskell%27s%20Missing%20Concurrency%20Basics" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;11&#x2F;haskells-missing-concurrency-basics&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;haskells-missing-concurrency-basics.md">Edit this page on Github</a>
        </i>
      </p>

      <p>I want to discuss two limitations in standard Haskell libraries around
concurrency, and discuss methods of improving the status quo. Overall,
Haskell's <a href="https://haskell-lang.org/library/async">concurrency</a>
<a href="https://haskell-lang.org/library/stm">story</a> is - in my opinion - the
best in class versus any other language I'm aware of, at least for the
single-machine use case. The following are two issues that I run into
fairly regularly and are a surprising wart:</p>
<ul>
<li><code>putStrLn</code> is not thread-safe</li>
<li>Channels cannot be closed</li>
</ul>
<p>Let me back up these claims, and then ask for some feedback on how to
solve them.</p>
<h2 id="putstrln-is-not-thread-safe"><code>putStrLn</code> is not thread-safe</h2>
<p>The example below is, in my opinion, a prime example of beautiful
concurrency in Haskell:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">replicateM_</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> replicateM_ </span><span style="color:#6c71c4;">5 </span><span style="color:#859900;">$</span><span style="color:#657b83;"> putStrLn </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hi, I&#39;m worker #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show num

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    mapConcurrently worker [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>Well, it's beautiful until you see the (abridged) output:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">Hi, HIiH&#39;HH,imii , ,,I w  &#39;IoIIm&#39;r&#39;&#39; mkmmw e  owrwwro ookr#rrek2kkre
ee rrr# H  3#i##
4,51
</span></code></pre>
<p>Your mileage may vary of course. The issue here is that
<code>Prelude.putStrLn</code> works on <code>String</code>, which is a lazy list of <code>Char</code>s,
and in fact sends one character at a time to <code>stdout</code>. This is clearly
<em>not</em> what we want. However, at the same time, many Haskellers -
myself included - consider <code>String</code>-based I/O a bad choice anyway. So
let's replace this with <code>Text</code>-based I/O:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">replicateM_</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text.IO </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> replicateM_ </span><span style="color:#6c71c4;">5
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">pack
           </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hi, I&#39;m worker #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show num

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    mapConcurrently worker [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>Unfortunately, if you run this (at least via <code>runghc</code>), the results
are the same. If you
<a href="https://www.stackage.org/haddock/lts-7.9/text-1.2.2.1/src/Data.Text.IO.html#hPutStr">look at the implementation of <code>Data.Text.IO.hPutStr</code></a>,
you'll see that there are different implementations of that function
depending on the buffering straregy of the <code>Handle</code> we're writing
to. In the case of <code>NoBuffering</code> (which is the default with GHCi and
<code>runghc</code>), this will output one character at a time (just like
<code>String</code>), whereas <code>LineBuffering</code> and <code>BlockBuffering</code> have batch
behavior. You can see this with:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">replicateM_</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text.IO </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">System.IO

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> replicateM_ </span><span style="color:#6c71c4;">5
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">pack
           </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hi, I&#39;m worker #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show num

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    hSetBuffering stdout </span><span style="color:#cb4b16;">LineBuffering</span><span style="color:#657b83;">
    mapConcurrently worker [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>While better, this still isn't perfect:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">Hi, I&#39;m worker #4Hi, I&#39;m worker #5Hi, I&#39;m worker #1


Hi, I&#39;m worker #4Hi, I&#39;m worker #5Hi, I&#39;m worker #1


Hi, I&#39;m worker #4Hi, I&#39;m worker #5
</span></code></pre>
<p>Unfortunately, because
<a href="https://www.stackage.org/haddock/lts-7.9/text-1.2.2.1/src/Data.Text.IO.html#hPutStrLn">newlines are written to stdout separately from the message</a>,
these kinds of issues happen too frequently. This can be worked around
too by using <code>putStr</code> instead and manually appending a newline
character:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">replicateM_</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Text.IO </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">T
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">System.IO

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> replicateM_ </span><span style="color:#6c71c4;">5
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStr
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">T</span><span style="color:#859900;">.</span><span style="color:#657b83;">pack
           </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hi, I&#39;m worker #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show num </span><span style="color:#859900;">++ </span><span style="color:#839496;">&quot;</span><span style="color:#dc322f;">\n</span><span style="color:#839496;">&quot;

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    hSetBuffering stdout </span><span style="color:#cb4b16;">LineBuffering</span><span style="color:#657b83;">
    mapConcurrently worker [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>Finally, we can avoid the buffering-dependent code in the text package
and use <code>ByteString</code> output, which has the advantage of automatically
using this append-a-newline logic for small-ish <code>ByteString</code>s:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">replicateM_</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString.Char</span><span style="color:#657b83;">8 </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">S</span><span style="color:#657b83;">8

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> replicateM_ </span><span style="color:#6c71c4;">100
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">S8</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn
           </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">S8</span><span style="color:#859900;">.</span><span style="color:#657b83;">pack
           </span><span style="color:#859900;">$ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Hi, I&#39;m worker #</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">++</span><span style="color:#657b83;"> show num

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    mapConcurrently worker [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">100</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>However, this has the downside of assuming a certain character
encoding, which may be different from the encoding of the <code>Handle</code>.</p>
<p><strong>What I'd like</strong> I would like a function <code>Text -&gt; IO ()</code> which -
regardless of buffering strategy - appends a newline to the <code>Text</code>
value and sends the entire chunk of data to a <code>Handle</code> in a
thread-safe manner. Ideally it would account for character encoding
(though assuming UTF8 may be an acceptable compromise for most use
cases), and it would be OK if very large values are occassionally
compromised during output (due to the <code>write</code> system call not
accepting the entire chunk at once).</p>
<p><strong>What I'd recommend today</strong> In a number of my smaller
applications/scripts, I've become accustomed to defining a <code>say = BS.hPutStrLn stdout . encodeUtf8</code>. I'm tempted to add this to a
library - possibly even <code>classy-prelude</code> - along with either
reimplementing <code>print</code> as <code>print = say . T.pack . show</code> (or providing
an alternative to <code>print</code>). I've also considered replacing the <code>putStrLn</code> in
<code>classy-prelude</code> with this implementation of <code>say</code>.</p>
<p>However, I'm hoping others have some better thoughts on this, because
I don't really find these solutions very appealing.</p>
<h2 id="non-closable-channels">Non-closable channels</h2>
<p>Let's implement a very simple multi-worker application with
communication over a <code>Chan</code>:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Monad </span><span style="color:#657b83;">(</span><span style="color:#b58900;">forever</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Text</span><span style="color:#657b83;">, </span><span style="color:#b58900;">pack</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text.Encoding </span><span style="color:#657b83;">(</span><span style="color:#b58900;">encodeUtf8</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString.Char</span><span style="color:#657b83;">8 </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">S</span><span style="color:#657b83;">8

</span><span style="color:#b58900;">say </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Text </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">say </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">S8</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn </span><span style="color:#859900;">.</span><span style="color:#657b83;"> encodeUtf8

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Chan Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker chan num </span><span style="color:#859900;">=</span><span style="color:#657b83;"> forever </span><span style="color:#859900;">$ do</span><span style="color:#657b83;">
    i </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> readChan chan
    say </span><span style="color:#859900;">$</span><span style="color:#657b83;"> pack </span><span style="color:#859900;">$</span><span style="color:#657b83;"> concat
        [ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Worker #</span><span style="color:#839496;">&quot;
        </span><span style="color:#657b83;">, show num
        , </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;"> received value </span><span style="color:#839496;">&quot;
        </span><span style="color:#657b83;">, show i
        ]

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    chan </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> newChan
    mapConcurrently (worker chan) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">] </span><span style="color:#859900;">`concurrently`</span><span style="color:#657b83;">
        mapM_ (writeChan chan) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">10</span><span style="color:#657b83;">]
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>(Yes, I used the aforementioned <code>say</code> function.)</p>
<p>This looks all well and good, but check out the end of the output:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#cb4b16;">Worker</span><span style="color:#657b83;"> #</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;"> received value </span><span style="color:#6c71c4;">8
</span><span style="color:#cb4b16;">Worker</span><span style="color:#657b83;"> #</span><span style="color:#6c71c4;">3</span><span style="color:#657b83;"> received value </span><span style="color:#6c71c4;">9
</span><span style="color:#cb4b16;">Worker</span><span style="color:#657b83;"> #</span><span style="color:#6c71c4;">1</span><span style="color:#657b83;"> received value </span><span style="color:#6c71c4;">10
</span><span style="color:#cb4b16;">Main</span><span style="color:#859900;">:</span><span style="color:#657b83;"> thread blocked indefinitely </span><span style="color:#859900;">in</span><span style="color:#657b83;"> an </span><span style="color:#cb4b16;">MVar</span><span style="color:#657b83;"> operation
</span></code></pre>
<p>You see, the worker threads have no way of knowing that there are no more <code>writeChan</code> calls incoming, so they continue to block. The runtime system notes this, and sends them an async exception to kill them. This is <a href="https://www.fpcomplete.com/blog/2016/06/async-exceptions-stm-deadlocks">a really bad idea for program structure</a> as it can easily lead to deadlocks. Said more simply:</p>
<p><img src="https://i.sli.mg/eX0QY1.jpg" alt="If you rely on exceptions for non-exceptional cases, you're gonna have a bad time" /></p>
<p>Instead, the workers should have some way of knowing that the channel
is closed. This is a common pattern in other languages, and one I
think we should borrow. Implementing this with STM isn't too bad
actually, and can easily have an <code>IO</code>-based API if desired:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Applicative </span><span style="color:#657b83;">(</span><span style="color:#b58900;">(&lt;|&gt;)</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.STM
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Text</span><span style="color:#657b83;">, </span><span style="color:#b58900;">pack</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text.Encoding </span><span style="color:#657b83;">(</span><span style="color:#b58900;">encodeUtf8</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString.Char</span><span style="color:#657b83;">8 </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">S</span><span style="color:#657b83;">8

</span><span style="color:#b58900;">say </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Text </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">say </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">S8</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn </span><span style="color:#859900;">.</span><span style="color:#657b83;"> encodeUtf8

</span><span style="color:#859900;">data </span><span style="color:#cb4b16;">TCChan</span><span style="color:#657b83;"> a </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">TCChan</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">TChan</span><span style="color:#657b83;"> a) (</span><span style="color:#cb4b16;">TVar Bool</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">newTCChan </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">TCChan a</span><span style="color:#657b83;">)
newTCChan </span><span style="color:#859900;">=</span><span style="color:#657b83;"> atomically </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">TCChan </span><span style="color:#859900;">&lt;$&gt;</span><span style="color:#657b83;"> newTChan </span><span style="color:#859900;">&lt;</span><span style="color:#657b83;">*</span><span style="color:#859900;">&gt;</span><span style="color:#657b83;"> newTVar </span><span style="color:#cb4b16;">False

</span><span style="color:#b58900;">closeTCChan </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">TCChan a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">closeTCChan (</span><span style="color:#cb4b16;">TCChan</span><span style="color:#657b83;"> _ var) </span><span style="color:#859900;">=</span><span style="color:#657b83;"> atomically </span><span style="color:#859900;">$</span><span style="color:#657b83;"> writeTVar var </span><span style="color:#cb4b16;">True

</span><span style="color:#b58900;">writeTCChan </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">TCChan a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">writeTCChan (</span><span style="color:#cb4b16;">TCChan</span><span style="color:#657b83;"> chan var) val </span><span style="color:#859900;">=</span><span style="color:#657b83;"> atomically </span><span style="color:#859900;">$ do</span><span style="color:#657b83;">
    closed </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> readTVar var
    </span><span style="color:#859900;">if</span><span style="color:#657b83;"> closed
        </span><span style="color:#93a1a1;">-- Could use nicer exception types, or return a Bool to
        -- indicate if writing failed
        </span><span style="color:#859900;">then</span><span style="color:#657b83;"> error </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Wrote to a closed TCChan</span><span style="color:#839496;">&quot;
        </span><span style="color:#859900;">else</span><span style="color:#657b83;"> writeTChan chan val

</span><span style="color:#b58900;">readTCChan </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">TCChan a </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO</span><span style="color:#657b83;"> (</span><span style="color:#268bd2;">Maybe a</span><span style="color:#657b83;">)
readTCChan (</span><span style="color:#cb4b16;">TCChan</span><span style="color:#657b83;"> chan var) </span><span style="color:#859900;">=</span><span style="color:#657b83;"> atomically </span><span style="color:#859900;">$</span><span style="color:#657b83;">
    (</span><span style="color:#cb4b16;">Just </span><span style="color:#859900;">&lt;$&gt;</span><span style="color:#657b83;"> readTChan chan) </span><span style="color:#859900;">&lt;|&gt;</span><span style="color:#657b83;"> (</span><span style="color:#859900;">do</span><span style="color:#657b83;">
        closed </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> readTVar var
        check closed
        return </span><span style="color:#cb4b16;">Nothing</span><span style="color:#657b83;">)

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">TCChan Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker chan num </span><span style="color:#859900;">=</span><span style="color:#657b83;">
    loop
  </span><span style="color:#859900;">where</span><span style="color:#657b83;">
    loop </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
        mi </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> readTCChan chan
        </span><span style="color:#859900;">case</span><span style="color:#657b83;"> mi </span><span style="color:#859900;">of
            </span><span style="color:#cb4b16;">Nothing </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()
            </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> i </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
                say </span><span style="color:#859900;">$</span><span style="color:#657b83;"> pack </span><span style="color:#859900;">$</span><span style="color:#657b83;"> concat
                    [ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Worker #</span><span style="color:#839496;">&quot;
                    </span><span style="color:#657b83;">, show num
                    , </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;"> received value </span><span style="color:#839496;">&quot;
                    </span><span style="color:#657b83;">, show i
                    ]
                loop

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    chan </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> newTCChan
    mapConcurrently (worker chan) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">] </span><span style="color:#859900;">`concurrently` do</span><span style="color:#657b83;">
        mapM_ (writeTCChan chan) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">10</span><span style="color:#657b83;">]
        closeTCChan chan
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p>Fortunately, this problem has a preexisting solution: the
<a href="https://www.stackage.org/package/stm-chans">stm-chans package</a>, which
provides closable and bounded channels and queues. Our problem above
can be more easily implemented with:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#657b83;">#</span><span style="color:#859900;">!/</span><span style="color:#657b83;">usr</span><span style="color:#859900;">/</span><span style="color:#657b83;">bin</span><span style="color:#859900;">/</span><span style="color:#657b83;">env stack
</span><span style="color:#93a1a1;">-- stack --resolver lts-6.23 --install-ghc runghc --package async --package text --package stm-chans
</span><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> OverloadedStrings #-}
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.Async
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.STM
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Control.Concurrent.STM.TMQueue
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Text</span><span style="color:#657b83;">, </span><span style="color:#b58900;">pack</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Text.Encoding </span><span style="color:#657b83;">(</span><span style="color:#b58900;">encodeUtf8</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.ByteString.Char</span><span style="color:#657b83;">8 </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">S</span><span style="color:#657b83;">8

</span><span style="color:#b58900;">say </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Text </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">say </span><span style="color:#859900;">= </span><span style="color:#cb4b16;">S8</span><span style="color:#859900;">.</span><span style="color:#657b83;">putStrLn </span><span style="color:#859900;">.</span><span style="color:#657b83;"> encodeUtf8

</span><span style="color:#b58900;">worker </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">TMQueue Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">Int </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">worker q num </span><span style="color:#859900;">=</span><span style="color:#657b83;">
    loop
  </span><span style="color:#859900;">where</span><span style="color:#657b83;">
    loop </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
        mi </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> atomically </span><span style="color:#859900;">$</span><span style="color:#657b83;"> readTMQueue q
        </span><span style="color:#859900;">case</span><span style="color:#657b83;"> mi </span><span style="color:#859900;">of
            </span><span style="color:#cb4b16;">Nothing </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> return </span><span style="color:#b58900;">()
            </span><span style="color:#cb4b16;">Just</span><span style="color:#657b83;"> i </span><span style="color:#859900;">-&gt; do</span><span style="color:#657b83;">
                say </span><span style="color:#859900;">$</span><span style="color:#657b83;"> pack </span><span style="color:#859900;">$</span><span style="color:#657b83;"> concat
                    [ </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">Worker #</span><span style="color:#839496;">&quot;
                    </span><span style="color:#657b83;">, show num
                    , </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;"> received value </span><span style="color:#839496;">&quot;
                    </span><span style="color:#657b83;">, show i
                    ]
                loop

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do</span><span style="color:#657b83;">
    q </span><span style="color:#859900;">&lt;-</span><span style="color:#657b83;"> newTMQueueIO
    mapConcurrently (worker q) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">5</span><span style="color:#657b83;">] </span><span style="color:#859900;">`concurrently` do</span><span style="color:#657b83;">
        mapM_ (atomically </span><span style="color:#859900;">.</span><span style="color:#657b83;"> writeTMQueue q) [</span><span style="color:#6c71c4;">1</span><span style="color:#859900;">..</span><span style="color:#6c71c4;">10</span><span style="color:#657b83;">]
        atomically </span><span style="color:#859900;">$</span><span style="color:#657b83;"> closeTMQueue q
    return </span><span style="color:#b58900;">()
</span></code></pre>
<p><strong>What I'd like</strong> The biggest change needed here is just to get
knowledge of this very awesome <code>stm-chans</code> package out there
more. That could be with blog posts, or even better with links from
the <code>stm</code> package itself. A step up from there could be to include
this functionality in the <code>stm</code> package itself. Another possible
niceity would be to add a non-STM API for these - whether based on STM
or MVars internally - for more ease of use. I may take a first step
here by simply depending on and reexporting <code>stm-chans</code> from
<code>classy-prelude</code>.</p>
<p><strong>What I'd recommend</strong> Probably pretty obvious: use <code>stm-chans</code>!</p>
<p>Like the previous point though, I'm interested to see how other people
have approached this problem, since I haven't heard it discussed much
in the past. Either others haven't run into this issue as frequently
as I have, everyone already knows about <code>stm-chans</code>, or there's some
other solution people prefer.</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
