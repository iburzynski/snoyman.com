
    

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Proposed conduit reskin</title>

    <meta name="twitter:site" content="@snoyberg">
    <meta name="twitter:creator" content="@snoyberg">
    <meta name="og:site_name" content="Michael Snoyman's homepage">
    <meta name="og:title" content="Proposed conduit reskin">
    <meta name="og:type content="website">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/maxi/vendors/font-awesome/css/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/maxi/css/styles.css">

    






    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/d26546d2-46db-4099-83ca-e1eccfa0dd8d">
    <link href="/rss.xml" type="application/atom+xml" rel="alternate" title="Michael Snoyman's blog">

    <style>.wt-section { padding-top: 2rem }</style>
  <body>
    <header class="inner-page">
      

<nav class="js-navbar-scroll navbar fixed-top navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/img/snoylogo.png" height="50px">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo" aria-controls="navbarTogglerDemo" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse onCollapse" id="navbarTogglerDemo">
      <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.yesodweb.com/">Yesod</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="http://shop.oreilly.com/product/0636920035664.do">Yesod Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.beginrust.com/">Rust Book</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://www.youtube.com/c/snoyberg">YouTube</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://twitter.com/snoyberg">Twitter</a>
        </li>
        <li class="nav-item mr-4 mb-2 mb-lg-0">
          <a class="nav-link" href="https://github.com/snoyberg">Github</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



      <section class="wt-section bg-gray text-center inner-page-header" style="padding-top:100px">
        <div class="container">
          <div class="row justify-content-md-center align-items-center text-white py-lg-5">
            <div class="col-md-7">
              <div class="text-center">
                <h1 class="display-sm-4 display-lg-3">Proposed conduit reskin</h1>
                
<p class="h6 text-uppercase wt-letter-spacing-sm mb-0">Published September 23, 2016</p>

              </div>
            </div>
          </div>
        </div>
      </section>
    </header>

    <main role="main">
      <section class="wt-section">
        <div class="container">
          <div class="row justify-content-between">
            <div class="col-lg-12">
              <p class="text-center">
                <a class="btn" style="background: #72472f; color: #fff; font-weight: bold" href="https://www.beginrust.com/">New: The "Begin Rust" book</a>
              </p>

              




  


<div class="share-bar-wrapper">
  <div class="share-bar-inner">
    <b>Share this</b>
    <a target="_blank" href="https://twitter.com/intent/tweet?text=Proposed%20conduit%20reskin https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;09&#x2F;proposed-conduit-reskin&#x2F;" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>

    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;09&#x2F;proposed-conduit-reskin&#x2F;" title="Share on Facebook">
      <i class="fab fa-facebook"></i>
    </a>

    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;09&#x2F;proposed-conduit-reskin&#x2F;&amp;title=Proposed%20conduit%20reskin" title="Share on LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>

    <a target="_blank" href="https://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;www.snoyman.com&#x2F;blog&#x2F;2016&#x2F;09&#x2F;proposed-conduit-reskin&#x2F;" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </div>
</div>



<!--
<div class="container" id="blog-body">
  <div class="row">
    <div class="col-lg-9">
-->
      <p>
        <i>
          See a typo? Have a suggestion?
          <a target="_blank" rel="nofollow" href="https://github.com/snoyberg/snoyman.com/edit/master/content/blog&#x2F;proposed-conduit-reskin.md">Edit this page on Github</a>
        </i>
      </p>

      <p>In a few different conversations I've had with people, the idea of
reskinning some of the surface syntax of the
<a href="https://github.com/snoyberg/conduit#readme">conduit library</a> has come
up, and I wanted to share the idea here. I call this &quot;reskinning&quot;
since all of the core functionality of conduit would remain unchanged
in this proposal, we'd just be changing operators and functions a bit.</p>
<p>The idea here is: conduit borrowed the operator syntax of <code>$$</code>, <code>=$</code>
and <code>$=</code> from enumerator, and it made sense at the beginning of its
lifecycle. However, for quite a while now conduit has evolved to the
point of having a unified type for <code>Source</code>s, <code>Conduit</code>s, and <code>Sink</code>s,
and the disparity of operators adds more confusion than it may be
worth. So without further ado, let's compare a few examples of conduit
usage between the current skin:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#cb4b16;">import </span><span style="color:#859900;">Conduit
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Conduit.Binary </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">CB

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do
    </span><span style="color:#93a1a1;">-- copy files
</span><span style="color:#657b83;">    runResourceT </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">CB</span><span style="color:#859900;">.</span><span style="color:#657b83;">sourceFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">source.txt</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">$$</span><span style="color:#657b83;"> sinkFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">dest.txt</span><span style="color:#839496;">&quot;

    </span><span style="color:#93a1a1;">-- sum some numbers
</span><span style="color:#657b83;">    print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> runIdentity </span><span style="color:#859900;">$</span><span style="color:#657b83;"> enumFromToC </span><span style="color:#6c71c4;">1 100 </span><span style="color:#859900;">$$</span><span style="color:#657b83;"> sumC

    </span><span style="color:#93a1a1;">-- print a bunch of numbers
</span><span style="color:#657b83;">    enumFromToC </span><span style="color:#6c71c4;">1 100 </span><span style="color:#859900;">$$</span><span style="color:#657b83;"> mapC (* </span><span style="color:#6c71c4;">2</span><span style="color:#657b83;">) </span><span style="color:#859900;">=$</span><span style="color:#657b83;"> takeWhileC (</span><span style="color:#859900;">&lt; </span><span style="color:#6c71c4;">100</span><span style="color:#657b83;">) </span><span style="color:#859900;">=$</span><span style="color:#657b83;"> mapM_C print
</span></code></pre>
<p>With a proposed reskin:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#cb4b16;">import </span><span style="color:#859900;">Conduit</span><span style="color:#657b83;">2
</span><span style="color:#cb4b16;">import qualified </span><span style="color:#859900;">Data.Conduit.Binary </span><span style="color:#cb4b16;">as </span><span style="color:#859900;">CB

</span><span style="color:#b58900;">main </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">IO </span><span style="color:#859900;">()
</span><span style="color:#657b83;">main </span><span style="color:#859900;">= do
    </span><span style="color:#93a1a1;">-- copy files
</span><span style="color:#657b83;">    runConduitRes </span><span style="color:#859900;">$ </span><span style="color:#cb4b16;">CB</span><span style="color:#859900;">.</span><span style="color:#657b83;">sourceFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">source.txt</span><span style="color:#839496;">&quot; </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> sinkFile </span><span style="color:#839496;">&quot;</span><span style="color:#2aa198;">dest.txt</span><span style="color:#839496;">&quot;

    </span><span style="color:#93a1a1;">-- sum some numbers
</span><span style="color:#657b83;">    print </span><span style="color:#859900;">$</span><span style="color:#657b83;"> runConduitPure </span><span style="color:#859900;">$</span><span style="color:#657b83;"> enumFromToC </span><span style="color:#6c71c4;">1 100 </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> sumC

    </span><span style="color:#93a1a1;">-- print a bunch of numbers
</span><span style="color:#657b83;">    runConduit </span><span style="color:#859900;">$</span><span style="color:#657b83;"> enumFromToC </span><span style="color:#6c71c4;">1 100 </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> mapC (* </span><span style="color:#6c71c4;">2</span><span style="color:#657b83;">) </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> takeWhileC (</span><span style="color:#859900;">&lt; </span><span style="color:#6c71c4;">100</span><span style="color:#657b83;">) </span><span style="color:#859900;">.|</span><span style="color:#657b83;"> mapM_C print
</span></code></pre>
<p>This reskin is easily defined with this module:</p>
<pre style="background-color:#fdf6e3;">
<code><span style="color:#b58900;">{-# </span><span style="color:#859900;">LANGUAGE</span><span style="color:#b58900;"> FlexibleContexts #-}
</span><span style="color:#859900;">module Conduit</span><span style="color:#657b83;">2
    ( </span><span style="color:#b58900;">module </span><span style="color:#268bd2;">Conduit
    </span><span style="color:#657b83;">, </span><span style="color:#b58900;">module </span><span style="color:#268bd2;">Conduit2</span><span style="color:#657b83;">
    ) </span><span style="color:#859900;">where

</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Conduit </span><span style="color:#cb4b16;">hiding </span><span style="color:#657b83;">(</span><span style="color:#b58900;">($$)</span><span style="color:#657b83;">, </span><span style="color:#b58900;">(=$)</span><span style="color:#657b83;">, </span><span style="color:#b58900;">($=)</span><span style="color:#657b83;">, </span><span style="color:#b58900;">(=$=)</span><span style="color:#657b83;">)
</span><span style="color:#cb4b16;">import </span><span style="color:#859900;">Data.Void </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Void</span><span style="color:#657b83;">)

</span><span style="color:#859900;">infixr </span><span style="color:#6c71c4;">2 </span><span style="color:#859900;">.|
</span><span style="color:#b58900;">(.|) </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">Monad m
     </span><span style="color:#859900;">=&gt; </span><span style="color:#268bd2;">ConduitM a b m </span><span style="color:#859900;">()
     -&gt; </span><span style="color:#268bd2;">ConduitM b c m r
     </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">ConduitM a c m r
</span><span style="color:#b58900;">(.|) </span><span style="color:#859900;">=</span><span style="color:#657b83;"> fuse

</span><span style="color:#b58900;">runConduitPure </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">ConduitM </span><span style="color:#859900;">() </span><span style="color:#268bd2;">Void Identity r </span><span style="color:#859900;">-&gt; </span><span style="color:#268bd2;">r
</span><span style="color:#657b83;">runConduitPure </span><span style="color:#859900;">=</span><span style="color:#657b83;"> runIdentity </span><span style="color:#859900;">.</span><span style="color:#657b83;"> runConduit

</span><span style="color:#b58900;">runConduitRes </span><span style="color:#859900;">:: </span><span style="color:#268bd2;">MonadBaseControl IO m
              </span><span style="color:#859900;">=&gt; </span><span style="color:#cb4b16;">ConduitM </span><span style="color:#b58900;">() </span><span style="color:#cb4b16;">Void</span><span style="color:#657b83;"> (</span><span style="color:#cb4b16;">ResourceT</span><span style="color:#657b83;"> m) r
              </span><span style="color:#859900;">-&gt;</span><span style="color:#657b83;"> m r
runConduitRes </span><span style="color:#859900;">=</span><span style="color:#657b83;"> runResourceT </span><span style="color:#859900;">.</span><span style="color:#657b83;"> runConduit
</span></code></pre>
<p>To put this in words:</p>
<ul>
<li>Replace the <code>$=</code>, <code>=$</code>, and <code>=$=</code> operators - which are all synonyms
of each other - with the <code>.|</code> operator. This borrows intuition from
the Unix shell, where the pipe operator denotes piping data from one
process to another. The analogy holds really well for conduit, so
why not borrow it? (We call all of these operators &quot;fusion.&quot;)</li>
<li>Get rid of the <code>$$</code> operator - also known as the &quot;connect&quot; or
&quot;fuse-and-run&quot; operator - entirely. Instead of having this
two-in-one action, separate it into <code>.|</code> and <code>runConduit</code>. The
advantage is that no one needs to think about whether to use <code>.|</code> or
<code>$$</code>, as happens today. (Note that <code>runConduit</code> is available in the
conduit library today, it's just not very well promoted.)</li>
<li>Now that <code>runConduit</code> is a first-class citizen, add in some helper
functions for two common use cases: running with <code>ResourceT</code> and
running a pure conduit.</li>
</ul>
<p>The goals here are to improve consistency, readability, and intuition
about the library. Of course, there are some downsides:</p>
<ul>
<li>There's a slight performance advantage (not benchmarked recently
unfortunately) to <code>foo $$ bar</code> versus <code>runConduit $ foo =$= bar</code>,
since the former combines both sets of actions into one. We may be
able to gain some of this back with GHC rewrite rules, but my
experience with rewrite rules in conduit has been less than
reliable.</li>
<li>Inertia: there's a lot of code and material out there using the
current set of operators. While we don't need to ever remove (or
even deprecate) the current operators, having two ways of writing
conduit code in the wild can be confusing.</li>
<li>Conflicting operator: doing a
<a href="https://www.stackage.org/lts-7.0/hoogle?q=.%7C">quick Hoogle search</a>
reveals that the parallel package already uses <code>.|</code>. We could choose
a different operator instead
(<a href="https://www.stackage.org/lts-7.0/hoogle?q=%7C."><code>|.</code></a> for instance
seems unclaimed), but generally I get nervous any time I'm defining
new operators.</li>
<li>For simple cases like <code>source $$ sink</code>, code is now quite a few keystrokes
longer: <code>runConduit $ source .| sink</code>.</li>
</ul>
<p>Code wise, this is a trivial change to implement. Updating docs to
follow this new convention wouldn't be too difficult either. The
question is: is this a good idea?</p>


<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>

      <div id="disqus_thread"></div>
      <script>
        (function() {var d = document, s = d.createElement('script'); s.src = '//snoyberg.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s);})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!--
    </div>

    <div class="col-lg-3" id="archive">
      <h3>Blog archive</h3>
      <ul class="blog-archive">
            $forall ((year, month, slug), post) <- posts
                <li>
                    <a href=@?{addPreview $ PostR year month slug}>#{postTitle post}
                    \ #
                    <i>#{prettyDay now (postTime post)}
-->

<div class="text-center"><a href="/blog/" class="btn btn-primary">Read more blog posts</a></div>


            </div>
          </div>
        </div>
      </section>
    </main>

    
<footer class="bg-dark py-5">
  <ul class="list-inline text-center text-md-right mb-0">
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/snoyberg">Follow @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://twitter.com/intent/tweet?screen_name=snoyberg">Tweet to @snoyberg</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://github.com/snoyberg">Github</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://tech.fpcomplete.com/">FP Complete</a>
    </li>
    <li class="list-inline-item mx-2">
      <a href="https://www.haskellers.com/user/snoyberg">I'm a Haskeller</a>
    </li>
  </ul>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-1434510-21', 'auto');
  ga('send', 'pageview');
</script>

<!-- JS Script Files -->
<!-- Global Vendor -->
<script src="/maxi/vendors/jquery.min.js"></script>
<script src="/maxi/vendors/jquery.migrate.min.js"></script>
<script src="/maxi/vendors/popper.min.js"></script>
<script src="/maxi/vendors/bootstrap/js/bootstrap.min.js"></script>

<!-- Components Vendor  --> 
<script src="/maxi/contact/jqBootstrapValidation.js"></script>
<!--Plugin Initialize-->
<script src="/maxi/js/global.js"></script>
<!-- END JAVASCRIPTS -->


  </body>
</html>
